name: On Merge Promote Branch Image to Prod
on:
  push:
    branches:
      - main

jobs:

  branch-and-last-commit:
    uses: brianjbayer/actions-image-cicd-workflows/.github/workflows/get-merged-branch-last-commit.yml@main

  branch-and-last-commit-merged-info:
    needs: [branch-and-last-commit]
    runs-on: ubuntu-latest
    env:
      BRANCH_LAST_COMMIT: ${{ needs.branch-and-last-commit.outputs.commit }}
      BRANCH: ${{ needs.branch-and-last-commit.outputs.branch }}

    steps:
      - name: Output last commit of merged branch env var
        run: echo "BRANCH_LAST_COMMIT=[${BRANCH_LAST_COMMIT}]"

      - name: Output last commit of merged branch raw
        run: echo "BRANCH LAST COMMIT is [${{ needs.branch-and-last-commit.outputs.commit }}]"

      - name: Output merged branch env var
        run: echo "BRANCH=[${BRANCH}]"

      - name: Output merged branch raw
        run: echo "BRANCH=[${BRANCH}]"

  promote-branch-last-commit-to-prod:
    needs: [branch-and-last-commit]
    uses: brianjbayer/actions-image-cicd-workflows/.github/workflows/pull-push-image.yml@main
    with:
      # Pull last (vetted) branch image
      pull_as: ${{ github.repository }}_${{ needs.branch-and-last-commit.outputs.branch }}:${{ needs.branch-and-last-commit.outputs.commit }}
      # Push prod Image
      push_as: ${{ github.repository }}:${{ needs.branch-and-last-commit.outputs.commit }}
    secrets:
      registry_u: ${{ secrets.DOCKER_HUB_USERNAME }}
      registry_p: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

  promote-branch-last-commit-to-prod-latest:
    needs: [branch-and-last-commit, promote-branch-last-commit-to-prod]
    uses: brianjbayer/actions-image-cicd-workflows/.github/workflows/pull-push-latest-image.yml@main
    with:
      image_name: ${{ github.repository }}
      image_tag: ${{ needs.branch-and-last-commit.outputs.commit }}
    secrets:
      registry_u: ${{ secrets.DOCKER_HUB_USERNAME }}
      registry_p: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

  promote-branch-last-commit-devenv:
    needs: [branch-and-last-commit]
    uses: brianjbayer/actions-image-cicd-workflows/.github/workflows/pull-push-image.yml@main
    with:
      # Pull last branch devenv image
      pull_as: ${{ github.repository }}_${{ needs.branch-and-last-commit.outputs.branch }}_dev:${{ needs.branch-and-last-commit.outputs.commit }}
      # Push prod devenv image
      push_as: ${{ github.repository }}-dev:${{ needs.branch-and-last-commit.outputs.commit }}
    secrets:
      registry_u: ${{ secrets.DOCKER_HUB_USERNAME }}
      registry_p: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

  promote-branch-last-commit-devenv-to-latest:
    needs: [branch-and-last-commit, promote-branch-last-commit-devenv]
    uses: brianjbayer/actions-image-cicd-workflows/.github/workflows/pull-push-latest-image.yml@main
    with:
      image_name: ${{ github.repository }}-dev
      image_tag: ${{ needs.branch-and-last-commit.outputs.commit }}
    secrets:
      registry_u: ${{ secrets.DOCKER_HUB_USERNAME }}
      registry_p: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
